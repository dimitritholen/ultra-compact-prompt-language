
> ucpl-compress-mcp@1.2.0 test
> node --test --test-reporter=spec

â–¶ Backup/Restore Safety Tests
  âœ” beforeEach creates backup successfully (5.382273ms)
  âœ” afterEach restores backup even when test fails (2.901383ms)
  âœ” afterEach handles missing backup gracefully (0.85235ms)
  âœ” beforeEach handles missing stats file gracefully (0.844539ms)
  âœ” restore executes in try/finally even on exception (1.563187ms)
  âœ” multiple backup/restore cycles work correctly (4.300521ms)
âœ” Backup/Restore Safety Tests (17.53258ms)
â–¶ Config Path Resolution - Integration Tests
  âœ” should resolve production config file path correctly (2.195631ms)
  âœ” should load config from production path with valid model (23.524957ms)
  âœ” should handle missing config file gracefully (37.753993ms)
  âœ” should handle malformed JSON config gracefully (41.805999ms)
  âœ” should handle invalid model in config (fallback to env) (34.202672ms)
  âœ” should validate config is a valid JSON object (29.179057ms)
  âœ” should handle empty config file gracefully (25.675038ms)
  âœ” should prioritize config over environment variables (22.664895ms)
  âœ” should handle config with null model field (23.936012ms)
  âœ” should handle config with additional fields (25.741164ms)
  âœ” should fall back to default when no config and no env vars (21.702287ms)
âœ” Config Path Resolution - Integration Tests (292.871309ms)
Starting cost reporting aggregation tests...

Lifecycle hooks: beforeEach/afterEach run automatically per test


=== Test 1: Total Cost Savings Aggregation ===
âœ“ Total cost savings aggregated correctly: $0.17933

=== Test 2: Average Cost Savings per Compression ===
âœ“ Average cost savings calculated correctly: $0.035866

=== Test 3: Model Breakdown Grouping ===
âœ“ Model breakdown grouped and sorted correctly
  1. claude-opus-4: 1 compressions, $0.08625
  2. claude-sonnet-4: 2 compressions, $0.05640
  3. gpt-4o: 1 compressions, $0.03645
  4. gemini-2.0-flash: 1 compressions, $0.00023

=== Test 4: Backward Compatibility (Missing Cost Fields) ===
âœ“ Handled mixed old/new records correctly
  - Records with cost: 1
  - Total cost savings: $0.0045

=== Test 5: USD Currency Formatting ===
âœ“ All currency values formatted correctly to 2 decimal places

=== Test 6: Model Breakdown Sorting ===
âœ“ Model breakdown sorted correctly by cost savings (descending)
  1. claude-opus-4: $0.0150
  2. claude-sonnet-4: $0.0024
  3. gpt-4o-mini: $0.0001

=== Test 7: Empty Records Handling ===
âœ“ Empty records handled correctly (no division by zero)

âœ… All cost reporting tests passed!

âœ” test-cost-reporting.js (69.211557ms)
â–¶ Cost Reporting Aggregation
  âœ” Total cost savings aggregation (2.455968ms)
  âœ” Average cost savings per compression (1.062351ms)
  âœ” Model breakdown grouping (1.269661ms)
  âœ” Backward compatibility with missing cost fields (0.704694ms)
  âœ” USD currency formatting (0.139642ms)
  âœ” Model breakdown sorting (0.954812ms)
  âœ” Empty records handling (0.815593ms)
âœ” Cost Reporting Aggregation (12.651972ms)
Starting cost tracking integration tests...

=== Test 1: Cost fields in compression records ===
âœ“ All cost fields present and valid
  - Model: claude-sonnet-4
  - Client: test-client
  - Price per MTok: $3
  - Cost savings: $0
  - Currency: USD

=== Test 2: LLM detection caching ===
âœ“ LLM detection called 1 time(s) for 3 compressions (cached correctly)

=== Test 3: Cost fields in estimated compressions ===
âœ“ All cost fields present in estimated compression
  - Model: claude-sonnet-4
  - Cost savings (estimated): $0

=== Test 4: Backward compatibility ===
âœ“ Backward compatibility maintained
  - Old records without cost fields: OK
  - New records with cost fields: OK

=== Test 5: Graceful handling of pricing failures ===
âœ“ Gracefully handles pricing unavailability
  - Basic stats still recorded: OK
  - Cost fields omitted: OK

=== Test 6: Cost calculation accuracy ===
âœ“ Cost calculations are accurate
  - 1,000 tokens â†’ $0
  - 100,000 tokens â†’ $0.3
  - 1,000,000 tokens â†’ $3

============================================================
Test Results: 6 passed, 0 failed
============================================================
[WARN] Cost calculation failed: Pricing service unavailable
âœ” test-cost-tracking.js (73.24215ms)
â–¶ Cost Tracking Integration
  â–¶ Cost fields in compression records
    âœ” should include all cost fields in compression record (4.856599ms)
  âœ” Cost fields in compression records (5.353236ms)
  â–¶ LLM detection caching
    âœ” should handle multiple compressions with consistent cost fields (5.598711ms)
  âœ” LLM detection caching (5.80783ms)
  â–¶ Estimated compressions
    âœ” should include cost fields in estimated compressions (3.128427ms)
  âœ” Estimated compressions (3.467886ms)
  â–¶ Backward compatibility
    âœ” should maintain backward compatibility with old stats (3.803496ms)
  âœ” Backward compatibility (4.20996ms)
  â–¶ Graceful error handling
    âœ” should handle pricing failures gracefully (1.046719ms)
  âœ” Graceful error handling (1.175205ms)
  â–¶ Cost calculation accuracy
    âœ” should calculate costs accurately for different token amounts (0.927329ms)
  âœ” Cost calculation accuracy (1.130879ms)
âœ” Cost Tracking Integration (26.238542ms)
[INFO] No client detected, defaulting to claude-sonnet-4
[ERROR] Cost calculation failed: Invalid tokensSaved: -100 (must be non-negative number)
[ERROR] Cost calculation failed: Invalid tokensSaved: NaN (must be non-negative number)
[ERROR] Cost calculation failed: Invalid tokensSaved: invalid (must be non-negative number)
[WARN] Unknown model 'totally-fake-model-xyz', using default claude-sonnet-4
âœ” test-date-helpers.js (72.86748ms)
ğŸ§ª Testing parseFlexibleDate() Function

âœ… Test 1: "now" returns current time
âœ… Test 2: "today" returns midnight today
âœ… Test 3: "-7d" returns 7 days ago
âœ… Test 4: "-2w" returns 14 days ago
âœ… Test 5: "-1m" returns ~30 days ago
âœ… Test 6: "-1y" returns ~365 days ago
âœ… Test 7: ISO date (start of current year)
âœ… Test 8: Full ISO timestamp
âœ… Test 9: null/undefined returns current time
âœ… Test 10: Invalid format throws error
   Correctly threw: Invalid date format: invalid-date. Expected ISO da...
âœ… Test 11: Invalid relative format throws error
   Correctly threw: Invalid date format: -7x. Expected ISO date (YYYY-...
âœ… Test 12: Malformed relative format throws error
   Correctly threw: Invalid date format: 7d. Expected ISO date (YYYY-M...

============================================================

ğŸ¯ Test Results: 12 passed, 0 failed

âœ… All parseFlexibleDate() tests passed!

âœ” test-date-parsing.js (73.399833ms)
â–¶ parseFlexibleDate() Function
  â–¶ Special Keywords
    âœ” "now" returns current time (0.998278ms)
    âœ” "today" returns midnight today (0.318871ms)
    âœ” null/undefined returns current time (1.627876ms)
  âœ” Special Keywords (4.075245ms)
  â–¶ Relative Date Parsing
    âœ” "-7d" returns 7 days ago (0.255888ms)
    âœ” "-2w" returns 14 days ago (0.122274ms)
    âœ” "-1m" returns ~30 days ago (0.154712ms)
    âœ” "-1y" returns ~365 days ago (0.086344ms)
  âœ” Relative Date Parsing (0.923319ms)
  â–¶ ISO Date Parsing
    âœ” ISO date "2025-01-01" (0.181998ms)
    âœ” Full ISO timestamp (0.148899ms)
  âœ” ISO Date Parsing (0.576298ms)
  â–¶ Error Handling
    âœ” Invalid format throws error (0.513539ms)
    âœ” Invalid relative format throws error (0.077275ms)
    âœ” Relative with missing unit is parsed as ISO date (0.045319ms)
  âœ” Error Handling (0.736086ms)
  â–¶ Edge Cases and Error Conditions
    âœ” should treat empty string as "now" (0.099641ms)
    âœ” should handle malformed relative dates (0.065937ms)
    âœ” should handle very large relative dates (0.045532ms)
    âœ” should handle special characters (0.054916ms)
    âœ” should reject whitespace-only input (0.0376ms)
    âœ” should handle negative years in ISO format (0.090581ms)
    âœ” should handle invalid month in ISO date (0.104512ms)
    âœ” should auto-correct invalid days (JavaScript Date behavior) (0.03887ms)
    âœ” should handle leap year edge cases (0.034944ms)
    âœ” should reject truly invalid formats (0.06317ms)
    âœ” should parse alternate date formats (JavaScript Date behavior) (0.032274ms)
    âœ” should parse slash-separated dates (JavaScript Date behavior) (0.02615ms)
  âœ” Edge Cases and Error Conditions (0.80845ms)
âœ” parseFlexibleDate() Function (7.933697ms)
============================================================
Error Isolation Test Suite
============================================================

Test 1: Verify all tests execute to completion

Test 2: Verify exit code reflects test results

Test 3: Verify error isolation (all tests complete)

Test 4: Verify clear failure reporting

âœ“ Failure count reported: true
âœ“ Pass count reported: true
âœ“ Test summary present: true

âœ… Test 4 PASSED

Exit code: 0

Stdout:
 ============================================================
Multi-tier Statistics Retention Test Suite
============================================================

Test 1: Migration from old format to new format
Test 2: Auto-aggregation on save
Test 3: Retention policy enforcement
âœ“ Old daily aggregates moved to monthly
âœ“ Monthly aggregates older than 5 years pruned
âœ“ Recent records older than 30 days moved to daily/monthly

Debug - Aggregated structure:
- Recent count: 1
- Daily keys: []
- Monthly keys: [ '2024-06', '2021-06' ]

âœ“ 2018-01 pruned: true (expected: true)
âœ“ 2021-06 in monthly: true (expected: true)
âœ… Test 3 PASSED

Test 4: File size growth bounds
âœ“ Uncompressed stats size: 6110 KB
âœ“ Recent records: 30000
âœ“ After aggregation: 6110 KB
âœ“ Recent records after aggregation: 30000
âœ“ Daily aggregates: 0
âœ“ Total records after aggregation: 30000 (max: 30500)
âœ… Test 4 PASSED

âœ“ Recent records: 2 (expected: 2)
âœ“ Daily aggregates: 2 (expected: 2)
âœ“ Monthly aggregates: 1 (expected: 1)
âœ“ Summary preserved: true
âœ… Test 1 PASSED

âœ“ Recent after aggregation: 2 (expected: 2)
âœ“ Daily after aggregation: 3 (expected: 3)
âœ“ Monthly after aggregation: 2 (expected: 2)
âœ… Test 2 PASSED

============================================================
Test Results:
============================================================
Passed: 4/4
Failed: 0/4

âœ… All tests PASSED!


Stderr:
 [INFO] Migration complete: 2 recent, 2 daily, 1 monthly


âœ“ All 4 tests executed: true
âœ“ Test Results section present: true
âœ“ Pass/Fail counts shown: true

âœ… Test 1 PASSED

âœ“ Exit code matches result: true

âœ… Test 2 PASSED

âœ“ Tests executed: 4 / 4
âœ“ All tests completed: true

âœ… Test 3 PASSED

============================================================
Test Results:
============================================================
Passed: 4/4
Failed: 0/4

âœ… All tests PASSED!
âœ” test-error-isolation.js (167.71939ms)
Testing event-based subprocess communication...

Starting MCP server subprocess...
Sending tools/list request...
âœ“ Response received in 56ms (event-based, not timeout-based)

âœ“ Response is valid JSON-RPC
âœ“ Response ID matches request ID
âœ“ Response contains result field

âœ“ Found 2 tools in response
  Tools: compress_code_context, get_compression_stats

âœ… SUCCESS! Event-based waiting works correctly!
   - No fixed timeouts used for synchronization
   - Response detected via actual stdout events
   - Response time: 56ms (actual time, not artificial delay)
âœ” test-event-based-waiting.js (98.034084ms)
Setup: Created test directory at /tmp/node-test-example-1762464281978
â–¶ Example Test Suite
  â–¶ File Operations
    âœ” should read file content (6.086023ms)
    âœ” should write file content (2.125606ms)
    âœ” should delete file (2.431454ms)
  âœ” File Operations (11.256761ms)
  â–¶ Assertions Examples
    âœ” should use strict equality (1.836927ms)
    âœ” should use deep strict equality for objects (0.949124ms)
    âœ” should check truthiness (0.909203ms)
    âœ” should check for exceptions (0.743743ms)
    âœ” should check for async rejections (0.967563ms)
    âœ” should use not equal assertions (0.984031ms)
  âœ” Assertions Examples (6.865432ms)
  â–¶ Async Patterns
    âœ” should handle promises (1.498715ms)
    âœ” should handle async/await (12.089927ms)
    âœ” should handle multiple async operations (1.19307ms)
  âœ” Async Patterns (15.115592ms)
  â–¶ Test Context Usage
    âœ” should use test context for diagnostics (1.495219ms)
    â„¹ This is a diagnostic message for debugging
    âœ” should access test name from context (2.384211ms)
  âœ” Test Context Usage (4.136682ms)
  â–¶ Edge Cases and Error Handling
    âœ” should handle null and undefined (1.825865ms)
    âœ” should handle empty collections (2.709072ms)
    âœ” should validate error messages (0.705136ms)
    âœ” should validate error types (0.618394ms)
  âœ” Edge Cases and Error Handling (6.100853ms)
Teardown: Removed test directory
âœ” Example Test Suite (46.650395ms)
âœ” standalone test example (0.130854ms)
â–¶ Parent Suite
  â–¶ Child Suite 1
    âœ” should run in child suite 1 (1.685684ms)
  âœ” Child Suite 1 (1.759899ms)
  â–¶ Child Suite 2
    âœ” should run in child suite 2 (0.151237ms)
  âœ” Child Suite 2 (0.217073ms)
âœ” Parent Suite (2.099648ms)
============================================================
Failure Simulation Test Suite
============================================================
Expected: 2 pass, 1 fail, 1 exception - all should execute

Test 1: Passing test
âœ… Test 1 PASSED

Test 2: Failing test
âŒ Test 2 FAILED

Test 3: Throwing test
Test 4: Passing test after exception
âœ… Test 4 PASSED

============================================================
Test Results:
============================================================
Passed: 2/4
Failed: 2/4

Tests with exceptions:

Verification:
âœ“ All 4 tests executed: true
âœ“ 2 tests passed: true
âœ“ 2 tests failed: true
âœ“ 1 exception caught: true

âœ… Error isolation verified! All tests executed despite failures.

âŒ throwingTest threw an exception: Error: Intentional test exception
    at Object.throwingTest [as fn] (/home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-failure-simulation.js:39:9)
    at /home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-failure-simulation.js:70:68
    at Array.map (<anonymous>)
    at runTests (/home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-failure-simulation.js:70:57)
    at Object.<anonymous> (/home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-failure-simulation.js:125:1)
    at Module._compile (node:internal/modules/cjs/loader:1730:14)
    at Object..js (node:internal/modules/cjs/loader:1895:10)
    at Module.load (node:internal/modules/cjs/loader:1465:32)
    at Function._load (node:internal/modules/cjs/loader:1282:12)
    at TracingChannel.traceSync (node:diagnostics_channel:322:14)
- throwingTest: Intentional test exception
âœ” test-failure-simulation.js (78.211982ms)
â–¶ File System Test Template
  âœ” example test (0.616968ms)
âœ” File System Test Template (7.510472ms)
â–¶ State Reset Test Template
  âœ” test 1 modifies state (0.253435ms)
  âœ” test 2 has fresh state (0.227234ms)
âœ” State Reset Test Template (0.655453ms)
â–¶ Resource Cleanup Test Template
  âœ” example test using resource (0.056027ms)
âœ” Resource Cleanup Test Template (0.223853ms)
â–¶ Environment Variable Test Template
  âœ” test with custom env vars (0.322917ms)
  âœ” env vars are restored (0.389807ms)
âœ” Environment Variable Test Template (0.854799ms)
â–¶ Mock Management Test Template
  âœ” mocking with automatic cleanup (0.242824ms)
  âœ” mocking methods (0.177206ms)
âœ” Mock Management Test Template (0.519645ms)
â–¶ Async Setup with Error Handling Template
  âœ” runs only if setup succeeded (1.60293ms)
âœ” Async Setup with Error Handling Template (13.021683ms)
â–¶ Custom Timeout Test Template
  âœ” fast test with default timeout (0.130207ms)
  âœ” slow test with custom timeout (100.323148ms)
âœ” Custom Timeout Test Template (100.671733ms)
â–¶ Parent Suite Template
  â–¶ Child Suite 1
    âœ” has access to both resources (0.148221ms)
  âœ” Child Suite 1 (0.226788ms)
  â–¶ Child Suite 2
    âœ” has access to parent but not sibling resources (0.124647ms)
  âœ” Child Suite 2 (0.186781ms)
âœ” Parent Suite Template (0.719444ms)
â–¶ Conditional Test Execution Template
  âœ” runs on all platforms (0.130171ms)
  âœ” linux-only test (0.113242ms)
  âœ” skip in CI (0.134906ms)
âœ” Conditional Test Execution Template (0.472539ms)
â–¶ Test Fixture Factory Template
  âœ” uses fixture instance 1 (0.20504ms)
  âœ” uses fresh fixture instance 2 (0.081237ms)
âœ” Test Fixture Factory Template (0.370145ms)
â–¶ Integration Coverage - Full Workflows
  â–¶ Compression Format Options
    âœ” compress with all format options (10514.812591ms)
  âœ” Compression Format Options (10515.201587ms)
  â–¶ Compression Level Options
    âœ” compress with all compression levels (10515.143149ms)
  âœ” Compression Level Options (10515.341219ms)
  â–¶ Statistics Period Options
    âœ” get_compression_stats with all period options (14020.384041ms)
  âœ” Statistics Period Options (14020.674969ms)
  â–¶ Statistics Date Range Queries
    âœ” get_compression_stats with date ranges (3504.699375ms)
    âœ” get_compression_stats with relative days (3505.932669ms)
  âœ” Statistics Date Range Queries (7011.340993ms)
  â–¶ Error Scenarios
    âœ” compress non-existent file returns error (3507.191914ms)
    âœ” compress with invalid level falls back gracefully (3506.083512ms)
    âœ” get_compression_stats with invalid date range (3506.336018ms)
  âœ” Error Scenarios (10520.184533ms)
  â–¶ Combined Parameter Workflows
    âœ” compress with include/exclude patterns (3506.224781ms)
    âœ” compress directory with pagination (7010.274034ms)
    âœ” stats with all filter options (3504.397316ms)
  âœ” Combined Parameter Workflows (14021.195801ms)
âœ” Integration Coverage - Full Workflows (66608.425699ms)
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  MCP Statistics Enhancement - Integration Test Suite        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Temp directory available: /tmp

ğŸ“… Date Parsing Tests (Task 001)
============================================================
âœ… Date parsing: ISO format "2025-01-01"
âœ… Date parsing: Relative "-7d"
âœ… Date parsing: Keyword "today"
âœ… Date parsing: Invalid format throws error
âœ… Date parsing: Full ISO timestamp

ğŸ” LLM Detection Tests (Task 005)
============================================================
âœ… LLM detection: Default fallback
âœ… LLM detection: Claude Desktop
âœ… LLM detection: Claude Code (VSCODE_PID)
âœ… LLM detection: Config file override
âœ… LLM detection: Invalid config fallback

ğŸ’° Cost Calculation Tests (Task 005)
============================================================
âœ… Cost calculation: Claude Sonnet 4 (1M tokens)
âœ… Cost calculation: Claude Opus 4 (500K tokens)
âœ… Cost calculation: Small amounts with rounding
âœ… Cost calculation: Zero tokens
âœ… Cost calculation: Negative tokens fallback

ğŸ“ Cost Recording Tests (Task 006)
============================================================
âœ… Cost recording: Fields present in compression records
âœ… Cost recording: Multiple models tracked

ğŸ“Š Cost Breakdown Tests (Task 007)
============================================================
âœ… Cost breakdown: Total cost savings
âœ… Cost breakdown: Average cost per compression
âœ… Cost breakdown: Model-specific breakdown
âœ… Cost breakdown: Records with/without cost

ğŸ” Stats Query Tests (Task 003)
============================================================
âœ… Stats query: Filter by relativeDays
âœ… Stats query: Custom date range
âœ… Stats query: No filters returns all

ğŸ’µ Pricing System Tests (Task 004)
============================================================
âœ… Pricing system: All models have pricing
âœ… Pricing system: Config file parsing
âœ… Pricing system: Invalid config fallback

============================================================

ğŸ¯ Test Results: 27 passed, 0 failed
â±ï¸  Execution time: 0.01s

ğŸ“Š Coverage Summary by Feature:
  - Task 001 (Date Parsing): 5 tests
  - Task 002 (Tool Schema): Covered by manual MCP Inspector validation
  - Task 003 (Stats Query): 3 tests
  - Task 004 (Pricing System): 3 tests
  - Task 005 (LLM Detection & Cost): 10 tests
  - Task 006 (Cost Recording): 2 tests
  - Task 007 (Cost Breakdown): 4 tests

âœ… All integration tests passed!

âœ” test-integration.js (55.408064ms)
â–¶ MCP Statistics Enhancement - Integration Tests
  â–¶ Date Parsing (Task 001)
    âœ” should parse ISO format "2025-01-01" (2.316785ms)
    âœ” should parse relative time "-7d" (0.530727ms)
    âœ” should parse keyword "today" (0.656873ms)
    âœ” should throw on invalid format (2.17947ms)
    âœ” should parse full ISO timestamp (0.591824ms)
  âœ” Date Parsing (Task 001) (6.936723ms)
[INFO] No client detected, defaulting to claude-sonnet-4
[INFO] Detected Claude Desktop (version: 1.0.0)
[INFO] Detected Claude Code/VSCode (version: unknown)
  â–¶ LLM Detection (Task 005)
    âœ” should default to unknown client when no env vars set (11.428655ms)
    âœ” should detect Claude Desktop from env var (1.251223ms)
    âœ” should detect Claude Code from VSCODE_PID (0.849746ms)
[INFO] Using model from config file: gpt-4o
    âœ” should use config file override (1.770865ms)
[WARN] Unknown model in config: invalid-model, falling back to env detection
[INFO] Using ANTHROPIC_MODEL env var: claude-opus-4
    âœ” should fallback to env detection when config has invalid model (3.041096ms)
  âœ” LLM Detection (Task 005) (18.804763ms)
  â–¶ Cost Calculation (Task 005)
    âœ” should calculate cost for Claude Sonnet 4 (1M tokens) (6.837569ms)
    âœ” should calculate cost for Claude Opus 4 (500K tokens) (0.888162ms)
    âœ” should round small amounts to nearest cent (0.621082ms)
    âœ” should handle zero tokens (0.57081ms)
[ERROR] Cost calculation failed: Invalid tokensSaved: -1000 (must be non-negative number)
    âœ” should fallback to 0 for negative tokens (3.378757ms)
  âœ” Cost Calculation (Task 005) (12.641211ms)
  â–¶ Cost Recording (Task 006)
    âœ” should include cost fields in compression records (3.757095ms)
    âœ” should track multiple models correctly (0.334409ms)
  âœ” Cost Recording (Task 006) (4.231086ms)
  â–¶ Cost Breakdown (Task 007)
    âœ” should calculate total cost savings (1.073792ms)
    âœ” should calculate average cost per compression (1.734576ms)
    âœ” should provide model-specific breakdown (0.451558ms)
    âœ” should count records with/without cost tracking (4.276517ms)
  âœ” Cost Breakdown (Task 007) (7.827105ms)
  â–¶ Stats Query (Task 003)
    âœ” should filter by relativeDays (0.788091ms)
    âœ” should filter by custom date range (0.63745ms)
    âœ” should return all records when no filters applied (0.30945ms)
  âœ” Stats Query (Task 003) (1.881481ms)
  â–¶ Pricing System (Task 004)
    âœ” should have pricing for all required models (0.564919ms)
    âœ” should parse config file correctly (1.723938ms)
[INFO] No client detected, defaulting to claude-sonnet-4
    âœ” should handle invalid config schema (2.1183ms)
  âœ” Pricing System (Task 004) (4.588163ms)
âœ” MCP Statistics Enhancement - Integration Tests (65.964485ms)
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Lifecycle Hook Verification Tests                          â•‘
â•‘  Demonstrates: afterEach runs even on test failure          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Test 1: Successful test (should cleanup)
  [beforeEach] Setup 1: Created /tmp/lifecycle-verify-1762464282006/test-marker.txt
  Test execution: Read marker file: "Setup 1"
  âœ… Test passed
  [afterEach] Teardown 1: Cleanup running (file exists)

Test 2: Failing test (should STILL cleanup)
  [beforeEach] Setup 2: Created /tmp/lifecycle-verify-1762464282006/test-marker.txt
  Test execution: Read marker file: "Setup 2"
  [afterEach] Teardown 2: Cleanup running (file exists)

Test 3: Test with uncaught exception (should STILL cleanup)
  [beforeEach] Setup 3: Created /tmp/lifecycle-verify-1762464282006/test-marker.txt
  Test execution: Read marker file: "Setup 3"
  [afterEach] Teardown 3: Cleanup running (file exists)

============================================================

Lifecycle hook execution summary:
  - setupTest() called: 3 times
  - teardownTest() called: 3 times
  - Expected: 3 setup calls, 3 teardown calls


Verification: Check if cleanup actually ran
  âœ… SUCCESS: Test directory removed - cleanup ran correctly!

============================================================

âœ… All lifecycle hooks verified!
   - beforeEach ran before each test
   - afterEach ran after each test (even on failure)
   - Cleanup guaranteed for test isolation

  âŒ Test failed: Intentional test failure
  âŒ Test exception: Uncaught exception in test
âœ” test-lifecycle-verification.js (50.80821ms)
Running LLM Detection and Cost Calculation Tests...

âœ“ Test 1: Default detection works
âœ“ Test 2: Claude Desktop detection works
âœ“ Test 3: Claude Code detection (VSCODE_PID) works
âœ“ Test 4: Claude Code detection (CLINE_VERSION) works
âœ“ Test 5: ANTHROPIC_MODEL env var works
âœ“ Test 6: OPENAI_MODEL env var works
âœ“ Test 7: Config file override works
âœ“ Test 8: Cost calculation for Claude Sonnet 4 works
âœ“ Test 9: Cost calculation for Claude Opus 4 works
âœ“ Test 10: Cost calculation for GPT-4o works
âœ“ Test 11: Cost calculation with rounding works
âœ“ Test 12: Cost calculation with zero tokens works
âœ“ Test 13: Cost calculation with auto-detect works
âœ“ Test 14: Invalid model fallback works

==================================================
Test Results: 14 passed, 0 failed
==================================================
âœ” test-llm-detection.js (54.031471ms)
â–¶ LLM Client Detection
  âœ” Default detection (no env vars) (5.411487ms)
  âœ” Claude Desktop detection (5.23561ms)
  âœ” Claude Code detection (VSCODE_PID) (2.481137ms)
  âœ” Claude Code detection (CLINE_VERSION) (0.98254ms)
[INFO] No client detected, defaulting to claude-sonnet-4
[INFO] Detected Claude Desktop (version: 1.0.0)
[INFO] Detected Claude Code/VSCode (version: unknown)
[INFO] Detected Claude Code/VSCode (version: 2.0.0)
  âœ” ANTHROPIC_MODEL env var (0.616507ms)
[INFO] Using ANTHROPIC_MODEL env var: claude-opus-4
[INFO] Using OPENAI_MODEL env var: gpt-4o
[INFO] Using model from config file: gpt-4o
  âœ” OPENAI_MODEL env var (1.105155ms)
  âœ” Config file override (1.722181ms)
âœ” LLM Client Detection (18.612593ms)
â–¶ Cost Calculation
  â–¶ Specific Models
    âœ” Claude Sonnet 4 (0.656976ms)
    âœ” Claude Opus 4 (0.667189ms)
    âœ” GPT-4o (0.449513ms)
  âœ” Specific Models (2.060871ms)
  â–¶ Edge Cases
    âœ” Small amounts (rounding) (1.107475ms)
    âœ” Zero tokens (0.239671ms)
[INFO] Using ANTHROPIC_MODEL env var: claude-opus-4
[WARN] Unknown model 'invalid-model', using default claude-sonnet-4
    âœ” Auto-detect model (4.292746ms)
    âœ” Invalid model fallback (0.547551ms)
  âœ” Edge Cases (6.340709ms)
âœ” Cost Calculation (8.579459ms)
[INFO] No client detected, defaulting to claude-sonnet-4
[INFO] No client detected, defaulting to claude-sonnet-4
â–¶ Config File Error Handling
  âœ” should handle malformed JSON gracefully (6.620047ms)
  âœ” should handle file permission errors (3.130074ms)
[INFO] No client detected, defaulting to claude-sonnet-4
  âœ” should handle non-object JSON (2.739598ms)
[INFO] No client detected, defaulting to claude-sonnet-4
  âœ” should handle null/undefined values (2.370063ms)
âœ” Config File Error Handling (15.168596ms)
Testing MCP server statistics recording...

  (No existing stats file to clean)
âœ“ Created temporary test file: /tmp/test-mcp-1762464282018.js

Sending test request to MCP server...
âœ“ Request sent

Polling for stats file creation...
STDERR output:
[INFO] No client detected, defaulting to claude-sonnet-4
[INFO] Recorded compression: /tmp/test-mcp-1762464282018.js - Original: 325 tokens, Compressed: 79 tokens, Saved: 246 tokens (76%), Cost saved: $0.00 (Claude Sonnet 4)


Response received (first 500 chars):
{"jsonrpc":"2.0","id":0,"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{}},"serverInfo":{"name":"ucpl-compress-mcp","version":"1.1.0"}}}
{"jsonrpc":"2.0","id":1,"result":{"content":[{"type":"text","text":"ğŸ“Š SUMMARY: 1 files\n\nğŸ“ˆ COMPRESSION STATS:\n  Original tokens:    317\n  Compressed tokens:  34\n  Savings:            89.3%\n\nğŸ“„ SAMPLE FILES (first 1):\n  1. /tmp/test-mcp-1762464282018.js (317 â†’ 34 tokens, 89% savings)\n\n\n"}]}}



Statistics file was created successfully!

Validating stats file structure...
Test error: AssertionError [ERR_ASSERTION]: Stats file recent[0]: costSavingsUSD (0.04) must match (tokensSaved/1M)*pricePerMTok (0.038826)
    at validateCompressionRecord (/home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-validation-helpers.js:150:12)
    at /home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-validation-helpers.js:227:5
    at Array.forEach (<anonymous>)
    at validateStatsFile (/home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-validation-helpers.js:226:16)
    at testMCPStatsRecording (/home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-mcp-stats.js:219:3) {
  generatedMessage: false,
  code: 'ERR_ASSERTION',
  actual: false,
  expected: true,
  operator: '=='
}
âœ– test-mcp-stats.js (1454.393661ms)
â–¶ MCP Server Statistics Recording
  ï¹£ should record statistics when compress_code_context is called (requires installed dependencies) (0.463638ms) # SKIP
  âœ” Manual: Test with real MCP Inspector to verify full integration (0.112226ms) # TODO
âœ” MCP Server Statistics Recording (4.161712ms)
  (No existing stats to backup)

Test 1: Single file compression...
  âœ… Stats file updated (0 â†’ 1)
  âœ… Record validation passed:
     - Tokens: 13031 â†’ 89 (saved: 12942)
     - Ratio: 0.007 (99.3% savings)
     - Path: server.js
     - Timestamp: 2025-11-06T21:24:43.189Z
  (No backup to restore)
â–¶ Real Compression Statistics Recording
  âœ” Single file compression (1467.738826ms)
âœ… Backed up existing stats file
âœ… Cleared stats file for clean test

Test 2: Directory compression (tests fallback)...
  âœ… Stats file updated (0 â†’ 1)
  âœ… Record validation passed:
     - Tokens: 27764 â†’ 163 (saved: 27601)
     - Ratio: 0.006 (99.4% savings)
  â“˜  Record not marked as estimated (accurate stats available)
âœ… Restored original stats file
  âœ” Directory compression (tests fallback) (1430.512072ms)
âœ… Backed up existing stats file
âœ… Cleared stats file for clean test

Test 3: Multiple sequential compressions...
âœ– test-real-compressions.js (2931.141125ms)
â–¶ Real Compression Statistics Recording
  â–¶ Single file compression
    âœ” should record compression for single file with valid data (4835.003321ms)
  âœ” Single file compression (4835.560843ms)
  â–¶ Directory compression
    âœ– should record compression for directory with fallback estimation (3514.800573ms)
  âœ– Directory compression (3515.329756ms)
  â–¶ Multiple sequential compressions
    âœ– should record all sequential compressions with valid data (10520.122065ms)
  âœ– Multiple sequential compressions (10520.514734ms)
  â–¶ Statistics retrieval
    âœ” should retrieve statistics correctly (3514.078647ms)
  âœ” Statistics retrieval (3514.262221ms)
âœ– Real Compression Statistics Recording (22386.203728ms)
â–¶ Schema validation for get_compression_stats
  âœ” tool name matches MCP naming requirements (0.748776ms)
  âœ” description is under 255 characters (0.125664ms)
  âœ” all parameters have valid type definitions (0.202023ms)
  âœ” all parameters have descriptions (0.244847ms)
  âœ” new date filtering parameters are present (0.135938ms)
  âœ” relativeDays has proper validation constraints (0.086229ms)
  âœ” backward compatibility is maintained (0.166217ms)
  âœ” includeDetails parameter has correct configuration (0.252105ms)
  âœ” limit parameter has proper constraints (0.303279ms)
âœ” Schema validation for get_compression_stats (5.637046ms)
â–¶ Schema Validation for get_compression_stats
  âœ” Tool name matches regex (0.644165ms)
  âœ” Description length is reasonable (0.237535ms)
  â–¶ Parameter Definitions
    âœ” All parameters have type (0.270934ms)
    âœ” All parameters have description (0.157413ms)
    âœ” Optional parameters have defaults or are marked optional (0.099965ms)
  âœ” Parameter Definitions (0.881909ms)
  â–¶ New Parameters
    âœ” startDate parameter exists (0.293373ms)
    âœ” endDate parameter exists (0.164227ms)
    âœ” relativeDays parameter exists (0.361922ms)
  âœ” New Parameters (1.050987ms)
  â–¶ Validation Constraints
    âœ” relativeDays has minimum constraint (0.190741ms)
    âœ” relativeDays has maximum constraint (0.156038ms)
    âœ” limit has valid constraints (0.057316ms)
  âœ” Validation Constraints (0.493858ms)
  â–¶ Backward Compatibility
    âœ” period parameter exists (0.063021ms)
    âœ” period has default (0.032842ms)
    âœ” period has oneOf options (0.037066ms)
  âœ” Backward Compatibility (0.20913ms)
âœ” Schema Validation for get_compression_stats (5.588249ms)
=== MCP Server Schema Validation Report ===

âœ“ Tool name format: compress_code_context âœ“
âœ“ Description length: 216 chars âœ“

=== Parameter Validation Constraints ===
  âœ“ path has minLength
  âœ“ path has maxLength
  âœ“ level has oneOf
  âœ“ level has default
  âœ“ language has oneOf
  âœ“ format has oneOf
  âœ“ format has default
  âœ“ include has items schema
  âœ“ include has minItems
  âœ“ exclude has items schema
  âœ“ exclude has minItems
  âœ“ limit has minimum
  âœ“ limit has maximum
  âœ“ offset has minimum
  âœ“ offset has default

=== Enum Pattern (oneOf vs enum) ===
  level: enum=false, oneOf=true âœ“
  language: enum=false, oneOf=true âœ“
  format: enum=false, oneOf=true âœ“

=== Output Schema ===
  Has outputSchema: âœ“
  Properties defined: compressed, metadata

=== Tool Annotations ===
  Has annotations: âœ“
  audience: ["assistant"] âœ“
  priority: 0.7 âœ“
  readOnlyHint: true âœ“
  destructiveHint: false âœ“
  openWorldHint: false âœ“

=== Parameter Description Lengths ===
  path: 97 chars âœ“
  level: 130 chars âœ“
  language: 104 chars âœ“
  format: 107 chars âœ“
  include: 66 chars âœ“
  exclude: 80 chars âœ“
  limit: 98 chars âœ“
  offset: 97 chars âœ“

=== Summary ===
Overall: âœ“ PASSED

Discoverability Score: 100/100 (100%)
âœ” test-schema.js (55.436263ms)
â–¶ MCP Server Schema Validation
  â–¶ Tool Name Format
    âœ” should have valid tool name format (0.671694ms)
  âœ” Tool Name Format (1.177934ms)
  â–¶ Description Length
    âœ” should have description within 255 character limit (0.199854ms)
  âœ” Description Length (1.431507ms)
  â–¶ Parameter Validation Constraints
    âœ” path should have minLength constraint (0.149406ms)
    âœ” path should have maxLength constraint (0.048133ms)
    âœ” level should have oneOf constraint (0.090587ms)
    âœ” level should have default value (0.050574ms)
    âœ” language should have oneOf constraint (0.126513ms)
    âœ” format should have oneOf constraint (0.08649ms)
    âœ” format should have default value (0.091965ms)
    âœ” include should have items schema (0.119499ms)
    âœ” include should have minItems constraint (0.043445ms)
    âœ” exclude should have items schema (0.03133ms)
    âœ” exclude should have minItems constraint (0.02653ms)
    âœ” limit should have minimum constraint (0.028173ms)
    âœ” limit should have maximum constraint (0.069317ms)
    âœ” offset should have minimum constraint (0.036361ms)
    âœ” offset should have default value (0.030108ms)
  âœ” Parameter Validation Constraints (1.333517ms)
  â–¶ Enum to oneOf Conversion
    âœ” level should use oneOf instead of enum (0.086895ms)
    âœ” language should use oneOf instead of enum (0.031858ms)
    âœ” format should use oneOf instead of enum (0.029734ms)
  âœ” Enum to oneOf Conversion (0.227799ms)
  â–¶ Output Schema
    âœ” should have outputSchema defined (0.106003ms)
    âœ” outputSchema should have properties (0.068708ms)
  âœ” Output Schema (0.27236ms)
  â–¶ Tool Annotations
    âœ” should have annotations defined (0.084421ms)
    âœ” should have audience annotation (0.040999ms)
    âœ” should have priority annotation (0.038536ms)
    âœ” should have readOnlyHint annotation (0.037962ms)
    âœ” should have destructiveHint annotation (0.038256ms)
    âœ” should have openWorldHint annotation (0.038238ms)
  âœ” Tool Annotations (0.365477ms)
  â–¶ Parameter Description Lengths
    âœ” all parameter descriptions should be reasonable length (1.394069ms)
    â„¹ path: 97 chars âœ“
    â„¹ level: 130 chars âœ“
    â„¹ language: 104 chars âœ“
    â„¹ format: 107 chars âœ“
    â„¹ include: 66 chars âœ“
    â„¹ exclude: 80 chars âœ“
    â„¹ limit: 98 chars âœ“
    â„¹ offset: 97 chars âœ“
  âœ” Parameter Description Lengths (1.509946ms)
  â–¶ Discoverability Score
    âœ” should calculate and verify discoverability score (0.299818ms)
    â„¹ Discoverability Score: 100/100 (100%)
  âœ” Discoverability Score (0.388292ms)
âœ” MCP Server Schema Validation (7.679352ms)
=== Statistics Recording Fallback Tests ===

Test 1: Accurate recording when readOriginalContent succeeds...
  âœ… Accurate recording works correctly
     Original: 1892, Compressed: 131, Saved: 1761 (93.1%)

Test 2: Fallback recording when readOriginalContent fails...
  âœ… Fallback recording works correctly
     Original (estimated): 400, Compressed: 40, Saved: 360 (90%)

Test 3: Estimation multipliers are correct...
  âœ… minimal: multiplier 10x is correct
  âœ… signatures: multiplier 6x is correct
  âœ… full: multiplier 4x is correct

Test 4: Multiple compressions are recorded correctly...
  âœ… Multiple compressions recorded correctly (5 â†’ 8)

Test 5: Summary statistics accumulate correctly...
  âœ… Summary statistics are correct
     Total compressions: 8
     Total tokens saved: 6071

âœ… Cleanup complete

=== Results: 5/5 tests passed ===
âœ… All tests passed!
âœ” test-statistics-fallback.js (4202.962194ms)
â–¶ Statistics Recording Fallback Tests
  â–¶ Accurate Recording
    âœ” should record accurately when readOriginalContent succeeds (5.864179ms)
    â„¹ Original: 96, Compressed: 42, Saved: 54 (56.3%)
  âœ” Accurate Recording (6.504166ms)
  â–¶ Fallback Recording
    âœ” should use fallback estimation when readOriginalContent fails (3.629886ms)
    â„¹ Original (estimated): 250, Compressed: 25, Saved: 225 (90%)
  âœ” Fallback Recording (3.819918ms)
  â–¶ Estimation Multipliers
    âœ” should use correct multiplier for minimal level (10.0x) (1.879323ms)
    âœ” should use correct multiplier for signatures level (6.0x) (0.724954ms)
    âœ” should use correct multiplier for full level (4.0x) (1.604687ms)
  âœ” Estimation Multipliers (4.678561ms)
  â–¶ Multiple Compressions
    âœ” should record multiple compressions correctly (3.530217ms)
  âœ” Multiple Compressions (3.814681ms)
  â–¶ Summary Accumulation
    âœ” should accumulate summary statistics correctly (0.926975ms)
  âœ” Summary Accumulation (1.101606ms)
âœ” Statistics Recording Fallback Tests (24.610093ms)
=== Token Statistics Integration Tests ===

âœ… Test fixtures loaded successfully

Testing token counting...
  Original tokens: 872
  Compressed tokens: 108
  Tokens saved: 764
  Compression ratio: 12.4%
  âœ… Token counting works correctly

Testing statistics persistence...
  âœ… Wrote test statistics
  âœ… Stats file structure is valid
  âœ… Summary fields validated
  âœ… Compression record fields validated
  âœ… All field values match expected
  âœ… Statistics persistence works correctly

Testing statistics calculations...
  Verifying token calculations:
    originalTokens: 100
    compressedTokens: 25
    tokensSaved: 75 (expected: 75)
  âœ… Token savings calculation is correct
  Verifying compression ratio:
    compressionRatio: 0.25 (expected: 0.250)
  âœ… Compression ratio calculation is correct
  Verifying savings percentage:
    savingsPercentage: 75% (expected: 75.0%)
  âœ… Savings percentage calculation is correct
  âœ… All field validations passed
  âœ… Statistics calculations are correct

âœ… Cleanup complete

=== Results: 3/3 tests passed ===
âœ… All tests passed!
âœ” test-statistics.js (610.474112ms)
â–¶ Token Statistics
  âœ” Token counting works correctly (542.916618ms)
  âœ” Statistics persistence works (2.870447ms)
  âœ” Statistics calculations are correct (0.549736ms)
âœ” Token Statistics (547.421086ms)
=== Statistics File Path Configuration Tests ===

Test 1: Verify server uses hardcoded statistics file path...
  âœ… Server uses hardcoded paths:
     STATS_DIR: os.homedir()/.ucpl/compress
     STATS_FILE: STATS_DIR/compression-stats.json
     Resolved: /home/dimitri/.ucpl/compress/compression-stats.json

Test 2: Verify UCPL_STATS_FILE environment variable is NOT used...
  âœ… No environment variable checks for stats file path found
     Confirmed: Server does NOT support UCPL_STATS_FILE or similar env vars

Test 3: Verify STATS_FILE constant is used directly...
  âœ… STATS_FILE constant used directly in:
     - loadStats() function
     - saveStats() function
     No environment variable indirection found

Test 4: Verify README documents hardcoded path...
  âœ… README.md documents:
     - Statistics file path: ~/.ucpl/compress/compression-stats.json
     - Path is hardcoded and cannot be configured

Test 5: Verify test files do not mock unused UCPL_STATS_FILE...
  âœ… test-statistics-fallback.js does NOT mock UCPL_STATS_FILE
     Test uses its own temporary file for isolation

=== Results: 5/5 tests passed ===
âœ… All tests passed!

ğŸ“ Summary:
   - Statistics file path is hardcoded: ~/.ucpl/compress/compression-stats.json
   - Environment variables for stats path are NOT supported
   - Tests do not mock unused environment variables
   - Documentation accurately reflects configuration behavior
âœ” test-stats-file-config.js (42.945621ms)
â–¶ get_compression_stats Integration Tests
  âœ” should filter by relativeDays=3 (last 3 days) (1.329404ms)
  âœ” should filter by relativeDays=7 (last week) (0.258184ms)
  âœ” should filter by relativeDays=30 (last 30 days) (0.300618ms)
  âœ” should filter by custom date range (last 14-7 days) (0.276138ms)
  âœ” should support legacy period=today (backward compatibility) (0.175112ms)
  âœ” should support legacy period=week (backward compatibility) (0.109975ms)
  âœ” should support legacy period=month (backward compatibility) (0.149931ms)
  âœ” should support legacy period=all (includes all tiers) (0.206752ms)
  âœ” should filter by ISO date range (specific dates) (0.256783ms)
  âœ” should prioritize relativeDays over period parameter (0.148638ms)
  âœ” should reject invalid relativeDays (out of range) (0.456353ms)
  âœ” should reject invalid date format (0.176919ms)
  âœ” should reject startDate after endDate (0.189809ms)
  âœ” should calculate cost savings correctly (0.206045ms)
  âœ” should track model breakdown correctly (0.092421ms)
  âœ” should include details when includeDetails=true (0.072378ms)
  âœ” should respect limit parameter with includeDetails (0.059536ms)
âœ” get_compression_stats Integration Tests (20.623115ms)
â–¶ get_compression_stats Date Range Queries
  âœ” should verify test stats file was created (4.318622ms)
  âœ” Manual: Test relativeDays=3 (last 3 days) - expects 2 compressions, 2250 tokens saved (0.169834ms) # TODO
  âœ” Manual: Test relativeDays=7 (last week) - expects 3 compressions, 3450 tokens saved (0.083826ms) # TODO
  âœ” Manual: Test relativeDays=30 (last 30 days) - expects 5 compressions, 6650 tokens saved (0.124807ms) # TODO
  âœ” Manual: Test startDate/endDate custom range (last 14-7 days) - expects 1-2 compressions (0.061217ms) # TODO
  âœ” Manual: Test legacy period=today (backward compatibility) - expects 1 compression, 750 tokens saved (0.094245ms) # TODO
  âœ” Manual: Test legacy period=week (backward compatibility) - expects 3 compressions, 3450 tokens saved (0.13101ms) # TODO
  âœ” Manual: Test legacy period=month (backward compatibility) - expects 5 compressions, 6650 tokens saved (0.104393ms) # TODO
  âœ” Manual: Test legacy period=all (includes all tiers) - expects 50 compressions, 87650 tokens saved (0.221391ms) # TODO
  âœ” Manual: Test ISO date range (specific dates) - expects 1-2 compressions (0.127337ms) # TODO
  âœ” Manual: Test relativeDays takes precedence over period - expects 3 compressions, 3450 tokens saved (0.042018ms) # TODO
  âœ” Manual: Test invalid relativeDays (400) - should error with "must be a number between 1 and 365" (0.037859ms) # TODO
  âœ” Manual: Test invalid date format - should error with "Invalid date format" (0.030434ms) # TODO
  âœ” Manual: Test startDate after endDate - should error with "Invalid date range" (0.032385ms) # TODO
âœ” get_compression_stats Date Range Queries (17.813821ms)
â–¶ Manual Test Documentation
  âœ” should display manual test instructions (0.191071ms)
  â„¹ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Manual Test Scenarios for get_compression_stats            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

To test this feature manually with MCP Inspector:

1. Start MCP server:
   npx @modelcontextprotocol/inspector node server.js

2. Test scenarios in Inspector:

   A. relativeDays Parameter:
      {"relativeDays": 3}
      {"relativeDays": 7}
      {"relativeDays": 30}

   B. Custom Date Ranges (ISO):
      {"startDate": "2025-01-01", "endDate": "2025-01-31"}
      {"startDate": "2025-01-15"}
      {"endDate": "2025-01-31"}

   C. Relative Time Strings:
      {"startDate": "-7d", "endDate": "now"}
      {"startDate": "-2w", "endDate": "-1w"}
      {"startDate": "-1m"}

   D. Legacy Backward Compatibility:
      {"period": "today"}
      {"period": "week"}
      {"period": "month"}
      {"period": "all"}

   E. Priority Order:
      {"relativeDays": 7, "period": "all"}  â†’ Uses relativeDays
      {"startDate": "-7d", "period": "all"} â†’ Uses startDate

   F. Error Cases:
      {"relativeDays": 400}  â†’ Error: out of range
      {"startDate": "invalid"} â†’ Error: invalid format
      {"startDate": "2025-02-01", "endDate": "2025-01-01"} â†’ Error

   G. Multi-tier Filtering:
      {"relativeDays": 90}  â†’ Includes recent + daily tiers
      {"period": "all"}     â†’ Includes all tiers + summary

Expected Results:
- All queries should return summary with correct token counts
- Period labels should reflect the actual date range used
- includeDetails=true should show individual compressions
- Cost savings should be calculated for all queries
- Backward compatibility maintained for existing period parameter

â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ” Manual Test Documentation (0.296759ms)
============================================================
Multi-tier Statistics Retention Test Suite
============================================================

Test 1: Migration from old format to new format
Test 2: Auto-aggregation on save
Test 3: Retention policy enforcement
âœ“ Old daily aggregates moved to monthly
âœ“ Monthly aggregates older than 5 years pruned
âœ“ Recent records older than 30 days moved to daily/monthly

Debug - Aggregated structure:
- Recent count: 1
- Daily keys: []
- Monthly keys: [ '2024-06', '2021-06' ]

âœ“ 2018-01 pruned: true (expected: true)
âœ“ 2021-06 in monthly: true (expected: true)
âœ… Test 3 PASSED

Test 4: File size growth bounds
âœ“ Uncompressed stats size: 6110 KB
âœ“ Recent records: 30000
âœ“ After aggregation: 6110 KB
âœ“ Recent records after aggregation: 30000
âœ“ Daily aggregates: 0
âœ“ Total records after aggregation: 30000 (max: 30500)
âœ… Test 4 PASSED

[INFO] Migration complete: 2 recent, 2 daily, 1 monthly
âœ“ Recent records: 2 (expected: 2)
âœ“ Daily aggregates: 2 (expected: 2)
âœ“ Monthly aggregates: 1 (expected: 1)
âœ“ Summary preserved: true
âœ… Test 1 PASSED

âœ“ Recent after aggregation: 2 (expected: 2)
âœ“ Daily after aggregation: 3 (expected: 3)
âœ“ Monthly after aggregation: 2 (expected: 2)
âœ… Test 2 PASSED

============================================================
Test Results:
============================================================
Passed: 4/4
Failed: 0/4

âœ… All tests PASSED!
âœ” test-stats-retention.js (133.923459ms)
â–¶ Multi-tier Statistics Retention
  â–¶ Migration from old format to new format
    âœ” should migrate compressions to correct tiers (2.083638ms)
    â„¹ Recent records: 2 (expected: 2)
    â„¹ Daily aggregates: 2 (expected: 2)
    â„¹ Monthly aggregates: 1 (expected: 1)
  âœ” Migration from old format to new format (2.636118ms)
  â–¶ Auto-aggregation on save
    âœ” should move old records to appropriate tiers (0.346959ms)
    â„¹ Recent after aggregation: 2 (expected: 2)
    â„¹ Daily after aggregation: 1 (expected: 1)
    â„¹ Monthly after aggregation: 1 (expected: 1)
  âœ” Auto-aggregation on save (0.540287ms)
  â–¶ Retention policy enforcement
    âœ” should prune old data according to policy (0.255818ms)
    â„¹ Aggregated structure:
    â„¹ - Recent count: 1
    â„¹ - Daily keys: 
    â„¹ - Monthly keys: 2024-06, 2021-06
  âœ” Retention policy enforcement (0.460134ms)
  â–¶ File size growth bounds
    âœ” should maintain bounded size with retention policy (67.690811ms)
    â„¹ Uncompressed stats size: 6110 KB
    â„¹ Recent records: 30000
    â„¹ After aggregation: 6110 KB
    â„¹ Recent records after aggregation: 30000
    â„¹ Daily aggregates: 0
    â„¹ Total records after aggregation: 30000 (max: 30500)
  âœ” File size growth bounds (67.997192ms)
âœ” Multi-tier Statistics Retention (72.299313ms)
âœ” test-utils.js (28.914481ms)
All assertAlmostEqual tests completed
â–¶ assertAlmostEqual - Happy Path Tests
  âœ” should pass when values are exactly equal (0.709582ms)
  âœ” should pass when difference is less than default epsilon (0.162342ms)
  âœ” should pass for floating-point addition (0.1 + 0.2) (0.091024ms)
  âœ” should pass for monetary values with default epsilon (0.106654ms)
  âœ” should pass with custom epsilon (0.967911ms)
  âœ” should pass for negative numbers within epsilon (0.090471ms)
  âœ” should pass for zero comparison (0.054889ms)
  âœ” should pass for large numbers within epsilon (0.092745ms)
âœ” assertAlmostEqual - Happy Path Tests (3.335717ms)
â–¶ assertAlmostEqual - Error Path Tests
  âœ” should throw when difference exceeds default epsilon (0.800965ms)
  âœ” should throw when difference exceeds custom epsilon (0.156777ms)
  âœ” should throw with custom error message (0.100628ms)
  âœ” should show actual, expected, and difference in error (0.133811ms)
âœ” assertAlmostEqual - Error Path Tests (1.475016ms)
â–¶ assertAlmostEqual - NaN Handling
  âœ” should pass when both values are NaN (0.08958ms)
  âœ” should throw when only actual is NaN (0.094476ms)
  âœ” should throw when only expected is NaN (0.067527ms)
âœ” assertAlmostEqual - NaN Handling (0.367511ms)
â–¶ assertAlmostEqual - Infinity Handling
  âœ” should pass when both values are positive Infinity (0.045425ms)
  âœ” should pass when both values are negative Infinity (0.033955ms)
  âœ” should throw when comparing positive and negative Infinity (0.074707ms)
  âœ” should throw when comparing finite to Infinity (0.897013ms)
âœ” assertAlmostEqual - Infinity Handling (1.198805ms)
â–¶ assertAlmostEqual - Negative Number Handling
  âœ” should handle negative numbers correctly (0.093584ms)
  âœ” should handle mixed sign comparisons (0.190943ms)
  âœ” should handle very small negative numbers (0.052612ms)
âœ” assertAlmostEqual - Negative Number Handling (0.581567ms)
â–¶ assertAlmostEqual - Boundary Conditions
  âœ” should pass when difference equals epsilon (boundary) (0.057122ms)
  âœ” should throw when difference slightly exceeds epsilon (0.228067ms)
  âœ” should handle very small epsilon values (0.083425ms)
  âœ” should handle very large epsilon values (0.058547ms)
âœ” assertAlmostEqual - Boundary Conditions (0.754936ms)
â–¶ assertAlmostEqual - Input Validation
  âœ” should throw TypeError when actual is not a number (0.103872ms)
  âœ” should throw TypeError when expected is not a number (0.131816ms)
  âœ” should throw TypeError when epsilon is not a number (0.117429ms)
  âœ” should throw TypeError when epsilon is negative (0.106135ms)
  âœ” should throw TypeError when epsilon is zero (0.046906ms)
  âœ” should throw TypeError when actual is null (0.048644ms)
  âœ” should throw TypeError when actual is undefined (0.036381ms)
âœ” assertAlmostEqual - Input Validation (0.854882ms)
â–¶ assertAlmostEqual - Default Epsilon Value
  âœ” should export DEFAULT_EPSILON constant (0.041476ms)
  âœ” should use DEFAULT_EPSILON when epsilon is omitted (0.090705ms)
âœ” assertAlmostEqual - Default Epsilon Value (0.233861ms)
â–¶ assertAlmostEqual - Real-World Use Cases
  âœ” should handle currency calculations (2 decimal places) (0.056106ms)
  âœ” should handle percentage calculations (0.03496ms)
  âœ” should handle cost savings aggregation (0.041592ms)
  âœ” should handle average calculations (0.03238ms)
âœ” assertAlmostEqual - Real-World Use Cases (0.287722ms)
=== Validation Helpers Unit Tests ===

âœ… validateCompressionRecord - accepts valid minimal record
âœ… validateCompressionRecord - accepts valid record with cost fields
âœ… validateCompressionRecord - accepts valid record with estimated flag
âœ… validateCompressionRecord - rejects missing timestamp
âœ… validateCompressionRecord - rejects invalid timestamp
âœ… validateCompressionRecord - rejects negative tokens
âœ… validateCompressionRecord - rejects non-integer tokens
âœ… validateCompressionRecord - rejects incorrect tokensSaved calculation
âœ… validateCompressionRecord - rejects invalid level
âœ… validateCompressionRecord - rejects invalid format
âœ… validateCompressionRecord - rejects savingsPercentage > 100
âœ… validateStatsSummary - accepts valid summary
âœ… validateStatsSummary - rejects negative values
âœ… validateStatsSummary - rejects non-integer values
âœ… validateStatsSummary - rejects incorrect calculation
âœ… validateStatsFile - accepts valid empty stats file
âœ… validateStatsFile - accepts valid stats file with records
âœ… validateStatsFile - rejects when requireRecords=true but no records
âœ… validateTimestamp - accepts valid ISO timestamp
âœ… validateTimestamp - rejects invalid timestamp
âœ… validateTimestamp - rejects future timestamp (more than 1 min)
âœ… validateRange - accepts value in range
âœ… validateRange - accepts boundary values
âœ… validateRange - rejects value below range
âœ… validateRange - rejects value above range

=== Results ===
âœ… Passed: 25
âŒ Failed: 0
Total: 25

âœ… All validation helper tests passed!
âœ” test-validation-helpers-unit.js (31.031241ms)
âœ” test-validation-helpers.js (37.794897ms)
âœ” test/fixtures/empty.js (30.159471ms)
âœ” test/fixtures/fixture-loader.js (21.919896ms)
âœ” test/fixtures/server-sample.js (53.053146ms)
âœ” test/fixtures/test-utils.js (23.159936ms)
â„¹ tests 329
â„¹ suites 92
â„¹ pass 310
â„¹ fail 4
â„¹ cancelled 0
â„¹ skipped 1
â„¹ todo 14
â„¹ duration_ms 66715.583364

âœ– failing tests:

test at test-mcp-stats.js:1:1
âœ– test-mcp-stats.js (1454.393661ms)
  'test failed'

test at test-real-compressions.js:1:1
âœ– test-real-compressions.js (2931.141125ms)
  Error: Unable to deserialize cloned data due to invalid or unsupported version.
      at #processRawBuffer (node:internal/test_runner/runner:353:20)
      at FileTest.parseMessage (node:internal/test_runner/runner:289:27)
      at Socket.<anonymous> (node:internal/test_runner/runner:399:15)
      at Socket.emit (node:events:518:28)
      at addChunk (node:internal/streams/readable:561:12)
      at readableAddChunkPushByteMode (node:internal/streams/readable:512:3)
      at Readable.push (node:internal/streams/readable:392:5)
      at Pipe.onStreamRead (node:internal/stream_base_commons:189:23)

test at test-real-compressions.test.mjs:179:5
âœ– should record compression for directory with fallback estimation (3514.800573ms)
  AssertionError [ERR_ASSERTION]: Record validation should pass. Errors: record: path mismatch (expected scripts, got /home/dimitri/dev/ultra-compact-prompt-language/mcp-server/server.js)
      at TestContext.<anonymous> (file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-real-compressions.test.mjs:202:14)
      at async Test.run (node:internal/test_runner/test:1054:7)
      at async Promise.all (index 0)
      at async Suite.run (node:internal/test_runner/test:1442:7)
      at async Suite.processPendingSubtests (node:internal/test_runner/test:744:7) {
    generatedMessage: false,
    code: 'ERR_ASSERTION',
    actual: false,
    expected: true,
    operator: '=='
  }

test at test-real-compressions.test.mjs:215:5
âœ– should record all sequential compressions with valid data (10520.122065ms)
  AssertionError [ERR_ASSERTION]: All compressions should be recorded (expected 3, got 6)
  
  6 !== 3
  
      at TestContext.<anonymous> (file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-real-compressions.test.mjs:237:14)
      at async Test.run (node:internal/test_runner/test:1054:7)
      at async Promise.all (index 0)
      at async Suite.run (node:internal/test_runner/test:1442:7)
      at async Suite.processPendingSubtests (node:internal/test_runner/test:744:7) {
    generatedMessage: false,
    code: 'ERR_ASSERTION',
    actual: 6,
    expected: 3,
    operator: 'strictEqual'
  }
