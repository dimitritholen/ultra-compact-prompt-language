
> ucpl-compress-mcp@1.2.0 test
> node --test --test-reporter=spec

  ✅ Created backup
▶ Backup/Restore Safety Tests
  ✔ beforeEach creates backup successfully (6.894712ms)
  ✅ Created backup
  ✅ Restored from backup
  ✔ afterEach restores backup even when test fails (6.630308ms)
  ℹ️  No backup to restore
  ✔ afterEach handles missing backup gracefully (1.541631ms)
  ℹ️  No existing stats to backup
  ✔ beforeEach handles missing stats file gracefully (1.825364ms)
  ✅ Created backup
  ✅ Restored from backup
  ✔ restore executes in try/finally even on exception (4.509734ms)
  ✅ Created backup
  ✅ Restored from backup
  ✅ Created backup
  ✅ Restored from backup
✖ test-backup-restore-safety.test.mjs (52.457168ms)
▶ Config Path Resolution - Integration Tests
  ✔ should resolve production config file path correctly (2.902558ms)
  ✔ should load config from production path with valid model (28.351962ms)
  ✔ should handle missing config file gracefully (27.606744ms)
  ✔ should handle malformed JSON config gracefully (24.676506ms)
  ✔ should handle invalid model in config (fallback to env) (26.690603ms)
  ✔ should validate config is a valid JSON object (22.055455ms)
  ✔ should handle empty config file gracefully (20.857463ms)
  ✔ should prioritize config over environment variables (20.118874ms)
  ✔ should handle config with null model field (19.943143ms)
  ✔ should handle config with additional fields (20.84035ms)
  ✔ should fall back to default when no config and no env vars (19.813782ms)
✔ Config Path Resolution - Integration Tests (238.226047ms)
▶ Cost Reporting Aggregation
  ✔ Total cost savings aggregation (3.288961ms)
  ✔ Average cost savings per compression (2.555798ms)
  ✔ Model breakdown grouping (0.707828ms)
  ✔ Backward compatibility with missing cost fields (0.668479ms)
  ✔ USD currency formatting (0.169299ms)
  ✔ Model breakdown sorting (5.421345ms)
  ✔ Empty records handling (0.964797ms)
✔ Cost Reporting Aggregation (18.986034ms)
[INFO] No client detected, defaulting to claude-sonnet-4
▶ Cost Tracking Integration
  ▶ Cost fields in compression records
    ✔ should include all cost fields in compression record (5.416618ms)
  ✔ Cost fields in compression records (5.794532ms)
  ▶ LLM detection caching
    ✔ should handle multiple compressions with consistent cost fields (4.634618ms)
  ✔ LLM detection caching (4.789947ms)
  ▶ Estimated compressions
    ✔ should include cost fields in estimated compressions (4.00021ms)
  ✔ Estimated compressions (4.269381ms)
  ▶ Backward compatibility
    ✔ should maintain backward compatibility with old stats (6.224267ms)
  ✔ Backward compatibility (6.478262ms)
  ▶ Graceful error handling
    ✔ should handle pricing failures gracefully (0.976433ms)
  ✔ Graceful error handling (1.092441ms)
  ▶ Cost calculation accuracy
    ✔ should calculate costs accurately for different token amounts (0.619115ms)
  ✔ Cost calculation accuracy (0.703708ms)
✔ Cost Tracking Integration (29.483699ms)
[ERROR] Cost calculation failed: Invalid tokensSaved: -100 (must be non-negative number)
[ERROR] Cost calculation failed: Invalid tokensSaved: NaN (must be non-negative number)
[ERROR] Cost calculation failed: Invalid tokensSaved: invalid (must be non-negative number)
[WARN] Unknown model 'totally-fake-model-xyz', using default claude-sonnet-4
✔ test-date-helpers.js (50.03037ms)
▶ parseFlexibleDate() Function
  ▶ Special Keywords
    ✔ "now" returns current time (0.610755ms)
    ✔ "today" returns midnight today (0.351856ms)
    ✔ null/undefined returns current time (0.192719ms)
  ✔ Special Keywords (3.344156ms)
  ▶ Relative Date Parsing
    ✔ "-7d" returns 7 days ago (0.217747ms)
    ✔ "-2w" returns 14 days ago (0.122218ms)
    ✔ "-1m" returns ~30 days ago (0.150975ms)
    ✔ "-1y" returns ~365 days ago (0.079056ms)
  ✔ Relative Date Parsing (0.883689ms)
  ▶ ISO Date Parsing
    ✔ ISO date "2025-01-01" (0.150645ms)
    ✔ Full ISO timestamp (0.136201ms)
  ✔ ISO Date Parsing (0.573686ms)
  ▶ Error Handling
    ✔ Invalid format throws error (0.478221ms)
    ✔ Invalid relative format throws error (0.07466ms)
    ✔ Relative with missing unit is parsed as ISO date (0.04667ms)
  ✔ Error Handling (0.701822ms)
  ▶ Edge Cases and Error Conditions
    ✔ should treat empty string as "now" (0.099297ms)
    ✔ should handle malformed relative dates (0.064255ms)
    ✔ should handle very large relative dates (0.041703ms)
    ✔ should handle special characters (0.066511ms)
    ✔ should reject whitespace-only input (0.040526ms)
    ✔ should handle negative years in ISO format (0.037729ms)
    ✔ should handle invalid month in ISO date (0.088572ms)
    ✔ should auto-correct invalid days (JavaScript Date behavior) (0.038774ms)
    ✔ should handle leap year edge cases (0.03052ms)
    ✔ should reject truly invalid formats (0.055382ms)
    ✔ should parse alternate date formats (JavaScript Date behavior) (0.029374ms)
    ✔ should parse slash-separated dates (JavaScript Date behavior) (0.025459ms)
  ✔ Edge Cases and Error Conditions (0.749383ms)
✔ parseFlexibleDate() Function (6.914187ms)
file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-error-isolation.test.mjs:13
const { spawn } = require('child_process');
                  ^

ReferenceError: require is not defined in ES module scope, you can use import instead
    at file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-error-isolation.test.mjs:13:19
    at ModuleJob.run (node:internal/modules/esm/module_job:274:25)
    at async onImport.tracePromise.__proto__ (node:internal/modules/esm/loader:644:26)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)

Node.js v22.16.0
✖ test-error-isolation.test.mjs (47.188117ms)
file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-event-based-waiting.test.mjs:9
const { spawn } = require('child_process');
                  ^

ReferenceError: require is not defined in ES module scope, you can use import instead
    at file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-event-based-waiting.test.mjs:9:19
    at ModuleJob.run (node:internal/modules/esm/module_job:274:25)
    at async onImport.tracePromise.__proto__ (node:internal/modules/esm/loader:644:26)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)

Node.js v22.16.0
✖ test-event-based-waiting.test.mjs (46.302174ms)
Setup: Created test directory at /tmp/node-test-example-1762465308936
▶ Example Test Suite
  ▶ File Operations
    ✔ should read file content (4.391196ms)
    ✔ should write file content (3.845564ms)
    ✔ should delete file (2.237078ms)
  ✔ File Operations (10.968572ms)
  ▶ Assertions Examples
    ✔ should use strict equality (2.337752ms)
    ✔ should use deep strict equality for objects (0.773235ms)
    ✔ should check truthiness (0.749111ms)
    ✔ should check for exceptions (0.943282ms)
    ✔ should check for async rejections (0.954727ms)
    ✔ should use not equal assertions (0.839734ms)
  ✔ Assertions Examples (7.062212ms)
  ▶ Async Patterns
    ✔ should handle promises (1.473827ms)
    ✔ should handle async/await (12.460762ms)
    ✔ should handle multiple async operations (0.954281ms)
  ✔ Async Patterns (15.159792ms)
  ▶ Test Context Usage
    ✔ should use test context for diagnostics (0.754719ms)
    ℹ This is a diagnostic message for debugging
    ✔ should access test name from context (1.996127ms)
  ✔ Test Context Usage (2.941014ms)
  ▶ Edge Cases and Error Handling
    ✔ should handle null and undefined (0.960789ms)
    ✔ should handle empty collections (0.598816ms)
    ✔ should validate error messages (0.677429ms)
    ✔ should validate error types (0.428479ms)
  ✔ Edge Cases and Error Handling (2.856052ms)
Teardown: Removed test directory
✔ Example Test Suite (42.644665ms)
✔ standalone test example (0.074052ms)
▶ Parent Suite
  ▶ Child Suite 1
    ✔ should run in child suite 1 (0.099414ms)
  ✔ Child Suite 1 (0.128175ms)
  ▶ Child Suite 2
    ✔ should run in child suite 2 (0.066251ms)
  ✔ Child Suite 2 (0.093741ms)
✔ Parent Suite (0.280282ms)
============================================================
Failure Simulation Test Suite
============================================================
Expected: 2 pass, 1 fail, 1 exception - all should execute

Test 1: Passing test
✅ Test 1 PASSED

Test 2: Failing test
❌ Test 2 FAILED

Test 3: Throwing test
Test 4: Passing test after exception
✅ Test 4 PASSED

============================================================
Test Results:
============================================================
Passed: 2/4
Failed: 2/4

Tests with exceptions:

Verification:
✓ All 4 tests executed: true
✓ 2 tests passed: true
✓ 2 tests failed: true
✓ 1 exception caught: true

✅ Error isolation verified! All tests executed despite failures.

❌ throwingTest threw an exception: Error: Intentional test exception
    at Object.throwingTest [as fn] (file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-failure-simulation.test.mjs:39:9)
    at file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-failure-simulation.test.mjs:70:68
    at Array.map (<anonymous>)
    at runTests (file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-failure-simulation.test.mjs:70:57)
    at file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-failure-simulation.test.mjs:125:1
    at ModuleJob.run (node:internal/modules/esm/module_job:274:25)
    at async onImport.tracePromise.__proto__ (node:internal/modules/esm/loader:644:26)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
- throwingTest: Intentional test exception
✔ test-failure-simulation.test.mjs (40.120928ms)
▶ File System Test Template
  ✔ example test (0.457699ms)
✔ File System Test Template (14.046611ms)
▶ State Reset Test Template
  ✔ test 1 modifies state (0.342577ms)
  ✔ test 2 has fresh state (0.346643ms)
✔ State Reset Test Template (1.0683ms)
▶ Resource Cleanup Test Template
  ✔ example test using resource (0.165309ms)
✔ Resource Cleanup Test Template (0.421469ms)
▶ Environment Variable Test Template
  ✔ test with custom env vars (0.296682ms)
  ✔ env vars are restored (0.460582ms)
✔ Environment Variable Test Template (0.93549ms)
▶ Mock Management Test Template
  ✔ mocking with automatic cleanup (0.254252ms)
  ✔ mocking methods (0.137953ms)
✔ Mock Management Test Template (0.501459ms)
▶ Async Setup with Error Handling Template
  ✔ runs only if setup succeeded (0.413483ms)
✔ Async Setup with Error Handling Template (11.224036ms)
▶ Custom Timeout Test Template
  ✔ fast test with default timeout (0.129358ms)
  ✔ slow test with custom timeout (100.582864ms)
✔ Custom Timeout Test Template (100.885571ms)
▶ Parent Suite Template
  ▶ Child Suite 1
    ✔ has access to both resources (0.096723ms)
  ✔ Child Suite 1 (0.150034ms)
  ▶ Child Suite 2
    ✔ has access to parent but not sibling resources (0.079646ms)
  ✔ Child Suite 2 (0.120058ms)
✔ Parent Suite Template (0.475767ms)
▶ Conditional Test Execution Template
  ✔ runs on all platforms (0.087477ms)
  ✔ linux-only test (0.078275ms)
  ✔ skip in CI (0.038669ms)
✔ Conditional Test Execution Template (0.25746ms)
▶ Test Fixture Factory Template
  ✔ uses fixture instance 1 (0.093914ms)
  ✔ uses fresh fixture instance 2 (0.033586ms)
✔ Test Fixture Factory Template (0.16093ms)
▶ Integration Coverage - Full Workflows
  ▶ Compression Format Options
    ✔ compress with all format options (10514.998246ms)
  ✔ Compression Format Options (10515.366502ms)
  ▶ Compression Level Options
    ✔ compress with all compression levels (10514.195441ms)
  ✔ Compression Level Options (10514.388488ms)
  ▶ Statistics Period Options
    ✔ get_compression_stats with all period options (14019.343178ms)
  ✔ Statistics Period Options (14019.632247ms)
  ▶ Statistics Date Range Queries
    ✔ get_compression_stats with date ranges (3506.833504ms)
    ✔ get_compression_stats with relative days (3508.039613ms)
  ✔ Statistics Date Range Queries (7015.402138ms)
  ▶ Error Scenarios
    ✔ compress non-existent file returns error (3506.291469ms)
    ✔ compress with invalid level falls back gracefully (3504.640919ms)
    ✔ get_compression_stats with invalid date range (3504.772482ms)
  ✔ Error Scenarios (10517.19824ms)
  ▶ Combined Parameter Workflows
    ✔ compress with include/exclude patterns (3504.943134ms)
    ✔ compress directory with pagination (7010.404599ms)
    ✔ stats with all filter options (3503.29383ms)
  ✔ Combined Parameter Workflows (14018.948287ms)
✔ Integration Coverage - Full Workflows (66604.512404ms)
▶ MCP Statistics Enhancement - Integration Tests
  ▶ Date Parsing (Task 001)
    ✔ should parse ISO format "2025-01-01" (2.495334ms)
    ✔ should parse relative time "-7d" (0.752951ms)
    ✔ should parse keyword "today" (0.843565ms)
    ✔ should throw on invalid format (1.858211ms)
    ✔ should parse full ISO timestamp (0.785352ms)
  ✔ Date Parsing (Task 001) (7.494387ms)
[INFO] Using model from config file: gpt-4o
  ▶ LLM Detection (Task 005)
    ✖ should default to unknown client when no env vars set (2.479335ms)
[INFO] Detected Claude Desktop (version: 1.0.0)
    ✔ should detect Claude Desktop from env var (1.21488ms)
[INFO] Detected Claude Code/VSCode (version: unknown)
    ✔ should detect Claude Code from VSCODE_PID (1.044005ms)
[INFO] Using model from config file: gpt-4o
    ✔ should use config file override (2.639426ms)
[WARN] Config file error: Unexpected non-whitespace character after JSON at position 25 (line 1 column 26)
[INFO] Using ANTHROPIC_MODEL env var: claude-opus-4
    ✔ should fallback to env detection when config has invalid model (2.766536ms)
  ✖ LLM Detection (Task 005) (10.546611ms)
  ▶ Cost Calculation (Task 005)
    ✔ should calculate cost for Claude Sonnet 4 (1M tokens) (1.718039ms)
    ✔ should calculate cost for Claude Opus 4 (500K tokens) (1.068473ms)
    ✔ should round small amounts to nearest cent (1.005671ms)
    ✔ should handle zero tokens (0.551767ms)
[ERROR] Cost calculation failed: Invalid tokensSaved: -1000 (must be non-negative number)
    ✔ should fallback to 0 for negative tokens (0.544361ms)
  ✔ Cost Calculation (Task 005) (5.280298ms)
  ▶ Cost Recording (Task 006)
    ✔ should include cost fields in compression records (2.378787ms)
    ✔ should track multiple models correctly (0.275723ms)
  ✔ Cost Recording (Task 006) (2.776725ms)
  ▶ Cost Breakdown (Task 007)
    ✔ should calculate total cost savings (0.438515ms)
    ✔ should calculate average cost per compression (0.232259ms)
    ✔ should provide model-specific breakdown (0.317945ms)
    ✔ should count records with/without cost tracking (0.456323ms)
  ✔ Cost Breakdown (Task 007) (1.595977ms)
  ▶ Stats Query (Task 003)
    ✔ should filter by relativeDays (0.661269ms)
    ✔ should filter by custom date range (1.055824ms)
    ✔ should return all records when no filters applied (0.392432ms)
  ✔ Stats Query (Task 003) (2.296813ms)
  ▶ Pricing System (Task 004)
    ✔ should have pricing for all required models (0.708745ms)
    ✔ should parse config file correctly (2.240455ms)
[INFO] No client detected, defaulting to claude-sonnet-4
    ✔ should handle invalid config schema (1.276846ms)
  ✔ Pricing System (Task 004) (4.37485ms)
✖ MCP Statistics Enhancement - Integration Tests (37.739239ms)
file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-lifecycle-verification.test.mjs:12
const fs = require('fs').promises;
           ^

ReferenceError: require is not defined in ES module scope, you can use import instead
    at file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-lifecycle-verification.test.mjs:12:12
    at ModuleJob.run (node:internal/modules/esm/module_job:274:25)
    at async onImport.tracePromise.__proto__ (node:internal/modules/esm/loader:644:26)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)

Node.js v22.16.0
✖ test-lifecycle-verification.test.mjs (28.740965ms)
[INFO] No client detected, defaulting to claude-sonnet-4
▶ LLM Client Detection
  ✔ Default detection (no env vars) (5.246997ms)
[INFO] Detected Claude Desktop (version: 1.0.0)
  ✔ Claude Desktop detection (1.566693ms)
[INFO] Detected Claude Code/VSCode (version: unknown)
  ✔ Claude Code detection (VSCODE_PID) (2.571865ms)
[INFO] Detected Claude Code/VSCode (version: 2.0.0)
  ✔ Claude Code detection (CLINE_VERSION) (0.838588ms)
[INFO] Using ANTHROPIC_MODEL env var: claude-opus-4
  ✔ ANTHROPIC_MODEL env var (0.911145ms)
[INFO] Using OPENAI_MODEL env var: gpt-4o
  ✔ OPENAI_MODEL env var (0.606348ms)
[INFO] Using model from config file: gpt-4o
  ✔ Config file override (1.286782ms)
✔ LLM Client Detection (13.994269ms)
▶ Cost Calculation
  ▶ Specific Models
    ✔ Claude Sonnet 4 (0.331753ms)
    ✔ Claude Opus 4 (0.278931ms)
    ✔ GPT-4o (0.219258ms)
  ✔ Specific Models (0.955307ms)
  ▶ Edge Cases
    ✔ Small amounts (rounding) (1.322135ms)
    ✔ Zero tokens (0.243162ms)
[INFO] Using ANTHROPIC_MODEL env var: claude-opus-4
[WARN] Unknown model 'invalid-model', using default claude-sonnet-4
    ✔ Auto-detect model (2.099481ms)
    ✔ Invalid model fallback (0.400096ms)
  ✔ Edge Cases (4.178165ms)
✔ Cost Calculation (5.280449ms)
[WARN] Config file error: Unexpected non-whitespace character after JSON at position 25 (line 1 column 26)
[INFO] No client detected, defaulting to claude-sonnet-4
▶ Config File Error Handling
  ✔ should handle malformed JSON gracefully (4.088443ms)
[INFO] No client detected, defaulting to claude-sonnet-4
  ✔ should handle file permission errors (2.342813ms)
[INFO] No client detected, defaulting to claude-sonnet-4
  ✔ should handle non-object JSON (2.50434ms)
[INFO] No client detected, defaulting to claude-sonnet-4
  ✔ should handle null/undefined values (1.726321ms)
✔ Config File Error Handling (10.900443ms)
▶ MCP Server Statistics Recording
  ﹣ should record statistics when compress_code_context is called (requires installed dependencies) (0.360359ms) # SKIP
  ✔ Manual: Test with real MCP Inspector to verify full integration (0.063895ms) # TODO
✔ MCP Server Statistics Recording (5.389623ms)
▶ Real Compression Statistics Recording
  ▶ Single file compression
    ✔ should record compression for single file with valid data (3510.406168ms)
  ✔ Single file compression (3510.872413ms)
  ▶ Directory compression
    ✔ should record compression for directory with fallback estimation (3510.142579ms)
  ✔ Directory compression (3510.324521ms)
  ▶ Multiple sequential compressions
    ✖ should record all sequential compressions with valid data (10518.059387ms)
  ✖ Multiple sequential compressions (10518.638998ms)
  ▶ Statistics retrieval
    ✔ should retrieve statistics correctly (3513.678832ms)
  ✔ Statistics retrieval (3513.850119ms)
✖ Real Compression Statistics Recording (21054.24964ms)
▶ Schema Validation for get_compression_stats
  ✔ Tool name matches regex (0.701002ms)
  ✔ Description length is reasonable (0.132307ms)
  ▶ Parameter Definitions
    ✔ All parameters have type (0.158507ms)
    ✔ All parameters have description (0.077576ms)
    ✔ Optional parameters have defaults or are marked optional (0.108649ms)
  ✔ Parameter Definitions (0.48675ms)
  ▶ New Parameters
    ✔ startDate parameter exists (0.141906ms)
    ✔ endDate parameter exists (0.091544ms)
    ✔ relativeDays parameter exists (0.199319ms)
  ✔ New Parameters (0.598996ms)
  ▶ Validation Constraints
    ✔ relativeDays has minimum constraint (0.275259ms)
    ✔ relativeDays has maximum constraint (0.250619ms)
    ✔ limit has valid constraints (0.090721ms)
  ✔ Validation Constraints (0.81366ms)
  ▶ Backward Compatibility
    ✔ period parameter exists (0.114638ms)
    ✔ period has default (0.113574ms)
    ✔ period has oneOf options (0.196584ms)
  ✔ Backward Compatibility (0.580956ms)
✔ Schema Validation for get_compression_stats (6.399971ms)
▶ MCP Server Schema Validation
  ▶ Tool Name Format
    ✔ should have valid tool name format (0.623345ms)
  ✔ Tool Name Format (1.138033ms)
  ▶ Description Length
    ✔ should have description within 255 character limit (0.127378ms)
  ✔ Description Length (1.932964ms)
  ▶ Parameter Validation Constraints
    ✔ path should have minLength constraint (0.226062ms)
    ✔ path should have maxLength constraint (0.074041ms)
    ✔ level should have oneOf constraint (0.124844ms)
    ✔ level should have default value (0.079668ms)
    ✔ language should have oneOf constraint (0.284703ms)
    ✔ format should have oneOf constraint (0.088742ms)
    ✔ format should have default value (0.085188ms)
    ✔ include should have items schema (0.113668ms)
    ✔ include should have minItems constraint (0.040307ms)
    ✔ exclude should have items schema (0.029526ms)
    ✔ exclude should have minItems constraint (0.024844ms)
    ✔ limit should have minimum constraint (0.027043ms)
    ✔ limit should have maximum constraint (0.036758ms)
    ✔ offset should have minimum constraint (0.021803ms)
    ✔ offset should have default value (0.023187ms)
  ✔ Parameter Validation Constraints (1.629825ms)
  ▶ Enum to oneOf Conversion
    ✔ level should use oneOf instead of enum (0.065926ms)
    ✔ language should use oneOf instead of enum (0.037493ms)
    ✔ format should use oneOf instead of enum (0.037239ms)
  ✔ Enum to oneOf Conversion (0.30135ms)
  ▶ Output Schema
    ✔ should have outputSchema defined (0.092128ms)
    ✔ outputSchema should have properties (0.056282ms)
  ✔ Output Schema (0.214549ms)
  ▶ Tool Annotations
    ✔ should have annotations defined (0.083138ms)
    ✔ should have audience annotation (0.038886ms)
    ✔ should have priority annotation (0.036733ms)
    ✔ should have readOnlyHint annotation (0.035006ms)
    ✔ should have destructiveHint annotation (0.034744ms)
    ✔ should have openWorldHint annotation (0.035606ms)
  ✔ Tool Annotations (0.343406ms)
  ▶ Parameter Description Lengths
    ✔ all parameter descriptions should be reasonable length (0.102578ms)
    ℹ path: 97 chars ✓
    ℹ level: 130 chars ✓
    ℹ language: 104 chars ✓
    ℹ format: 107 chars ✓
    ℹ include: 66 chars ✓
    ℹ exclude: 80 chars ✓
    ℹ limit: 98 chars ✓
    ℹ offset: 97 chars ✓
  ✔ Parameter Description Lengths (0.949707ms)
  ▶ Discoverability Score
    ✔ should calculate and verify discoverability score (0.31912ms)
    ℹ Discoverability Score: 100/100 (100%)
  ✔ Discoverability Score (0.375532ms)
✔ MCP Server Schema Validation (7.424983ms)
▶ Statistics Recording Fallback Tests
  ▶ Accurate Recording
    ✔ should record accurately when readOriginalContent succeeds (6.446982ms)
    ℹ Original: 96, Compressed: 42, Saved: 54 (56.3%)
  ✔ Accurate Recording (6.869589ms)
  ▶ Fallback Recording
    ✔ should use fallback estimation when readOriginalContent fails (3.117068ms)
    ℹ Original (estimated): 250, Compressed: 25, Saved: 225 (90%)
  ✔ Fallback Recording (3.249895ms)
  ▶ Estimation Multipliers
    ✔ should use correct multiplier for minimal level (10.0x) (1.364879ms)
    ✔ should use correct multiplier for signatures level (6.0x) (3.288687ms)
    ✔ should use correct multiplier for full level (4.0x) (2.558955ms)
  ✔ Estimation Multipliers (7.640842ms)
  ▶ Multiple Compressions
    ✔ should record multiple compressions correctly (6.044463ms)
  ✔ Multiple Compressions (6.412379ms)
  ▶ Summary Accumulation
    ✔ should accumulate summary statistics correctly (1.591163ms)
  ✔ Summary Accumulation (1.747914ms)
✔ Statistics Recording Fallback Tests (30.556348ms)
▶ Token Statistics
  ✔ Token counting works correctly (452.236584ms)
  ✔ Statistics persistence works (2.956637ms)
  ✔ Statistics calculations are correct (0.481455ms)
✔ Token Statistics (456.572509ms)
file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-stats-file-config.test.mjs:12
const fs = require('fs').promises;
           ^

ReferenceError: require is not defined in ES module scope, you can use import instead
    at file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-stats-file-config.test.mjs:12:12
    at ModuleJob.run (node:internal/modules/esm/module_job:274:25)
    at async onImport.tracePromise.__proto__ (node:internal/modules/esm/loader:644:26)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)

Node.js v22.16.0
✖ test-stats-file-config.test.mjs (24.753003ms)
▶ get_compression_stats Date Range Queries
  ✔ should verify test stats file was created (3.084194ms)
  ✔ Manual: Test relativeDays=3 (last 3 days) - expects 2 compressions, 2250 tokens saved (0.11087ms) # TODO
  ✔ Manual: Test relativeDays=7 (last week) - expects 3 compressions, 3450 tokens saved (0.047969ms) # TODO
  ✔ Manual: Test relativeDays=30 (last 30 days) - expects 5 compressions, 6650 tokens saved (0.092155ms) # TODO
  ✔ Manual: Test startDate/endDate custom range (last 14-7 days) - expects 1-2 compressions (0.166258ms) # TODO
  ✔ Manual: Test legacy period=today (backward compatibility) - expects 1 compression, 750 tokens saved (0.116623ms) # TODO
  ✔ Manual: Test legacy period=week (backward compatibility) - expects 3 compressions, 3450 tokens saved (0.136284ms) # TODO
  ✔ Manual: Test legacy period=month (backward compatibility) - expects 5 compressions, 6650 tokens saved (0.175635ms) # TODO
  ✔ Manual: Test legacy period=all (includes all tiers) - expects 50 compressions, 87650 tokens saved (0.239852ms) # TODO
  ✔ Manual: Test ISO date range (specific dates) - expects 1-2 compressions (0.14019ms) # TODO
  ✔ Manual: Test relativeDays takes precedence over period - expects 3 compressions, 3450 tokens saved (0.043857ms) # TODO
  ✔ Manual: Test invalid relativeDays (400) - should error with "must be a number between 1 and 365" (0.035634ms) # TODO
  ✔ Manual: Test invalid date format - should error with "Invalid date format" (0.032119ms) # TODO
  ✔ Manual: Test startDate after endDate - should error with "Invalid date range" (0.029418ms) # TODO
✔ get_compression_stats Date Range Queries (12.294607ms)
▶ Manual Test Documentation
  ✔ should display manual test instructions (0.174154ms)
  ℹ ╔══════════════════════════════════════════════════════════════╗
║  Manual Test Scenarios for get_compression_stats            ║
╚══════════════════════════════════════════════════════════════╝

To test this feature manually with MCP Inspector:

1. Start MCP server:
   npx @modelcontextprotocol/inspector node server.js

2. Test scenarios in Inspector:

   A. relativeDays Parameter:
      {"relativeDays": 3}
      {"relativeDays": 7}
      {"relativeDays": 30}

   B. Custom Date Ranges (ISO):
      {"startDate": "2025-01-01", "endDate": "2025-01-31"}
      {"startDate": "2025-01-15"}
      {"endDate": "2025-01-31"}

   C. Relative Time Strings:
      {"startDate": "-7d", "endDate": "now"}
      {"startDate": "-2w", "endDate": "-1w"}
      {"startDate": "-1m"}

   D. Legacy Backward Compatibility:
      {"period": "today"}
      {"period": "week"}
      {"period": "month"}
      {"period": "all"}

   E. Priority Order:
      {"relativeDays": 7, "period": "all"}  → Uses relativeDays
      {"startDate": "-7d", "period": "all"} → Uses startDate

   F. Error Cases:
      {"relativeDays": 400}  → Error: out of range
      {"startDate": "invalid"} → Error: invalid format
      {"startDate": "2025-02-01", "endDate": "2025-01-01"} → Error

   G. Multi-tier Filtering:
      {"relativeDays": 90}  → Includes recent + daily tiers
      {"period": "all"}     → Includes all tiers + summary

Expected Results:
- All queries should return summary with correct token counts
- Period labels should reflect the actual date range used
- includeDetails=true should show individual compressions
- Cost savings should be calculated for all queries
- Backward compatibility maintained for existing period parameter

╚══════════════════════════════════════════════════════════════╝
✔ Manual Test Documentation (0.269107ms)
▶ Multi-tier Statistics Retention
  ▶ Migration from old format to new format
    ✔ should migrate compressions to correct tiers (1.530389ms)
    ℹ Recent records: 2 (expected: 2)
    ℹ Daily aggregates: 2 (expected: 2)
    ℹ Monthly aggregates: 1 (expected: 1)
  ✔ Migration from old format to new format (1.962408ms)
  ▶ Auto-aggregation on save
    ✔ should move old records to appropriate tiers (0.296515ms)
    ℹ Recent after aggregation: 2 (expected: 2)
    ℹ Daily after aggregation: 1 (expected: 1)
    ℹ Monthly after aggregation: 1 (expected: 1)
  ✔ Auto-aggregation on save (0.59988ms)
  ▶ Retention policy enforcement
    ✔ should prune old data according to policy (0.137985ms)
    ℹ Aggregated structure:
    ℹ - Recent count: 1
    ℹ - Daily keys: 
    ℹ - Monthly keys: 2024-06, 2021-06
  ✔ Retention policy enforcement (0.209884ms)
  ▶ File size growth bounds
    ✔ should maintain bounded size with retention policy (66.847248ms)
    ℹ Uncompressed stats size: 6110 KB
    ℹ Recent records: 30000
    ℹ After aggregation: 6110 KB
    ℹ Recent records after aggregation: 30000
    ℹ Daily aggregates: 0
    ℹ Total records after aggregation: 30000 (max: 30500)
  ✔ File size growth bounds (66.993043ms)
✔ Multi-tier Statistics Retention (70.254808ms)
✔ test-utils.js (24.432745ms)
▶ assertAlmostEqual - Happy Path Tests
  ✔ should pass when values are exactly equal (0.704666ms)
  ✔ should pass when difference is less than default epsilon (0.11898ms)
  ✔ should pass for floating-point addition (0.1 + 0.2) (0.063244ms)
  ✔ should pass for monetary values with default epsilon (0.08753ms)
  ✔ should pass with custom epsilon (0.080635ms)
  ✔ should pass for negative numbers within epsilon (0.061706ms)
  ✔ should pass for zero comparison (0.048281ms)
  ✔ should pass for large numbers within epsilon (0.114121ms)
✔ assertAlmostEqual - Happy Path Tests (2.245446ms)
▶ assertAlmostEqual - Error Path Tests
  ✔ should throw when difference exceeds default epsilon (0.976389ms)
  ✔ should throw when difference exceeds custom epsilon (0.200817ms)
  ✔ should throw with custom error message (0.263889ms)
  ✔ should show actual, expected, and difference in error (0.140958ms)
✔ assertAlmostEqual - Error Path Tests (1.90084ms)
▶ assertAlmostEqual - NaN Handling
  ✔ should pass when both values are NaN (0.104723ms)
  ✔ should throw when only actual is NaN (0.101247ms)
  ✔ should throw when only expected is NaN (0.06587ms)
✔ assertAlmostEqual - NaN Handling (0.437022ms)
▶ assertAlmostEqual - Infinity Handling
  ✔ should pass when both values are positive Infinity (0.039162ms)
  ✔ should pass when both values are negative Infinity (0.031851ms)
  ✔ should throw when comparing positive and negative Infinity (0.064829ms)
  ✔ should throw when comparing finite to Infinity (0.076503ms)
✔ assertAlmostEqual - Infinity Handling (0.330735ms)
▶ assertAlmostEqual - Negative Number Handling
  ✔ should handle negative numbers correctly (0.038407ms)
  ✔ should handle mixed sign comparisons (0.113898ms)
  ✔ should handle very small negative numbers (0.033879ms)
✔ assertAlmostEqual - Negative Number Handling (0.281255ms)
▶ assertAlmostEqual - Boundary Conditions
  ✔ should pass when difference equals epsilon (boundary) (0.03785ms)
  ✔ should throw when difference slightly exceeds epsilon (0.105107ms)
  ✔ should handle very small epsilon values (0.149985ms)
  ✔ should handle very large epsilon values (0.059934ms)
✔ assertAlmostEqual - Boundary Conditions (0.506498ms)
▶ assertAlmostEqual - Input Validation
  ✔ should throw TypeError when actual is not a number (0.086096ms)
  ✔ should throw TypeError when expected is not a number (0.122597ms)
  ✔ should throw TypeError when epsilon is not a number (0.07205ms)
  ✔ should throw TypeError when epsilon is negative (0.11263ms)
  ✔ should throw TypeError when epsilon is zero (0.067438ms)
  ✔ should throw TypeError when actual is null (0.067141ms)
  ✔ should throw TypeError when actual is undefined (0.052458ms)
✔ assertAlmostEqual - Input Validation (0.856368ms)
▶ assertAlmostEqual - Default Epsilon Value
  ✔ should export DEFAULT_EPSILON constant (0.058796ms)
  ✔ should use DEFAULT_EPSILON when epsilon is omitted (0.119272ms)
✔ assertAlmostEqual - Default Epsilon Value (0.287025ms)
▶ assertAlmostEqual - Real-World Use Cases
  ✔ should handle currency calculations (2 decimal places) (0.067747ms)
  ✔ should handle percentage calculations (0.13621ms)
  ✔ should handle cost savings aggregation (0.064551ms)
  ✔ should handle average calculations (0.053564ms)
✔ assertAlmostEqual - Real-World Use Cases (1.34916ms)
file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-validation-helpers-unit.test.mjs:8
const assert = require('assert');
               ^

ReferenceError: require is not defined in ES module scope, you can use import instead
    at file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-validation-helpers-unit.test.mjs:8:16
    at ModuleJob.run (node:internal/modules/esm/module_job:274:25)
    at async onImport.tracePromise.__proto__ (node:internal/modules/esm/loader:644:26)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)

Node.js v22.16.0
✖ test-validation-helpers-unit.test.mjs (30.496652ms)
✔ test-validation-helpers.js (23.06109ms)
✔ test/fixtures/empty.js (18.13782ms)
✔ test/fixtures/fixture-loader.js (18.339348ms)
✔ test/fixtures/server-sample.js (46.668375ms)
✔ test/fixtures/test-utils.js (19.317517ms)
ℹ tests 289
ℹ suites 90
ℹ pass 266
ℹ fail 8
ℹ cancelled 0
ℹ skipped 1
ℹ todo 14
ℹ duration_ms 66674.681141

✖ failing tests:

test at test-backup-restore-safety.test.mjs:1:1
✖ test-backup-restore-safety.test.mjs (52.457168ms)
  Error: Unable to deserialize cloned data due to invalid or unsupported version.
      at #processRawBuffer (node:internal/test_runner/runner:353:20)
      at FileTest.parseMessage (node:internal/test_runner/runner:289:27)
      at Socket.<anonymous> (node:internal/test_runner/runner:399:15)
      at Socket.emit (node:events:518:28)
      at addChunk (node:internal/streams/readable:561:12)
      at readableAddChunkPushByteMode (node:internal/streams/readable:512:3)
      at Readable.push (node:internal/streams/readable:392:5)
      at Pipe.onStreamRead (node:internal/stream_base_commons:189:23)

test at test-error-isolation.test.mjs:1:1
✖ test-error-isolation.test.mjs (47.188117ms)
  'test failed'

test at test-event-based-waiting.test.mjs:1:1
✖ test-event-based-waiting.test.mjs (46.302174ms)
  'test failed'

test at test-integration.test.mjs:249:5
✖ should default to unknown client when no env vars set (2.479335ms)
  AssertionError [ERR_ASSERTION]: Expected values to be strictly equal:
  + actual - expected
  
  + 'config-override'
  - 'unknown'
  
      at TestContext.<anonymous> (file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-integration.test.mjs:252:14)
      at async Test.run (node:internal/test_runner/test:1054:7)
      at async Promise.all (index 0)
      at async Suite.run (node:internal/test_runner/test:1442:7)
      at async Suite.processPendingSubtests (node:internal/test_runner/test:744:7) {
    generatedMessage: true,
    code: 'ERR_ASSERTION',
    actual: 'config-override',
    expected: 'unknown',
    operator: 'strictEqual'
  }

test at test-lifecycle-verification.test.mjs:1:1
✖ test-lifecycle-verification.test.mjs (28.740965ms)
  'test failed'

test at test-real-compressions.test.mjs:215:5
✖ should record all sequential compressions with valid data (10518.059387ms)
  AssertionError [ERR_ASSERTION]: Record 2 should be valid. Errors: record: path mismatch (expected test-statistics.js, got /home/dimitri/dev/ultra-compact-prompt-language/mcp-server/server.js), record: level mismatch (expected full, got minimal)
      at TestContext.<anonymous> (file:///home/dimitri/dev/ultra-compact-prompt-language/mcp-server/test-real-compressions.test.mjs:247:16)
      at async Test.run (node:internal/test_runner/test:1054:7)
      at async Promise.all (index 0)
      at async Suite.run (node:internal/test_runner/test:1442:7)
      at async Suite.processPendingSubtests (node:internal/test_runner/test:744:7) {
    generatedMessage: false,
    code: 'ERR_ASSERTION',
    actual: false,
    expected: true,
    operator: '=='
  }

test at test-stats-file-config.test.mjs:1:1
✖ test-stats-file-config.test.mjs (24.753003ms)
  'test failed'

test at test-validation-helpers-unit.test.mjs:1:1
✖ test-validation-helpers-unit.test.mjs (30.496652ms)
  'test failed'
